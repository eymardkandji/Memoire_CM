{% extends 'web/base.html' %}
{% load custom_filters %}
{% block title %} Dashboard - Cluster Manager {% endblock %}
{% block base-content %}
<div class="container-fluid pt-4 px-4">
    <div class="col-sm-12 col-xl-6" style="width: 100%">
        <div class="rounded h-100 p-4">
            {% for node in nodes_state %}
                {% if node.status == 'online' %}
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item bg-transparent mt-4">
                            <h2 class="accordion-header" id="heading-{{ node.node }}">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ node.node }}" aria-expanded="true" aria-controls="collapse-{{ node.node }}">
                                    <i class="fa bi-toggle2-on fa-2x me-4"></i>{{ node.node }}
                                </button>
                            </h2>
                            <div id="collapse-{{ node.node }}" class="accordion-collapse collapse show" aria-labelledby="heading-{{ node.node }}" data-bs-parent="#accordionExample">
                                <div class="row g-4">
                                    <div class="col-sm-6 col-xl-3">
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4 mt-3">
                                            <i class="fa fa-memory fa-3x text-primary"></i>
                                            <div class="ms-3">
                                                <p class="mb-2">Memory</p>
                                                <h6 class="mb-0">{{ node.maxmem }} Gio</h6>
                                            </div>
                                        </div>
                                        <canvas id="pie-chart-{{ node.node }}-memory" class="bg-secondary pb-3"></canvas>
                                    </div>
                                    <div class="col-sm-6 col-xl-3">
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4 mt-3">
                                            <i class="fa fa-hdd fa-3x text-primary"></i>
                                            <div class="ms-3">
                                                <p class="mb-2">Hard Disk</p>
                                                <h6 class="mb-0">{{ node.disk }} Gio</h6>
                                            </div>
                                        </div>
                                        <canvas id="pie-chart-{{ node.node }}-disk" class="bg-secondary pb-3"></canvas>
                                    </div>
                                    <div class="col-sm-6 col-xl-3">
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4 mt-3">
                                            <i class="fa bi-cpu-fill fa-3x text-primary"></i>
                                            <div class="ms-3">
                                                <p class="mb-2">CPU</p>
                                                <h6 class="mb-0">{{ node.maxcpu }} core</h6>
                                            </div>
                                        </div>
                                        <canvas id="pie-chart-{{ node.node }}-cpu" class="bg-secondary pb-3"></canvas>
                                    </div>
                                    <div class="col-sm-6 col-xl-3">
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4 mt-3">
                                            <h2 class="mx-auto text-primary fa-3x">{{ node.uptime|format_timedelta }}</h2>
                                        </div>
                                        <div class="bg-secondary d-flex align-items-center justify-content-between px-4">
                                            <i class="bi-clock-history fa-10x position-relative mx-auto my-0 py-0"></i>
                                        </div>
                                        <div class="bg-secondary d-flex align-items-center justify-content-between px-4 py-3">
                                            <h3 class="mx-auto">Uptime</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        document.addEventListener("DOMContentLoaded", function() {
                            var ctxMemory = document.getElementById("pie-chart-{{ node.node }}-memory").getContext("2d");
                            var ctxDisk = document.getElementById("pie-chart-{{ node.node }}-disk").getContext("2d");
                            var ctxCpu = document.getElementById("pie-chart-{{ node.node }}-cpu").getContext("2d");

                            var dataMemory = [{{ node.mem }}, {{ node.maxmem|add:node.mem }}];
                            var dataDisk = [{{ node.disk }}, {{ node.maxdisk|add:node.disk }}];
                            var dataCpu = [ {{ node.cpu }}, {{ node.maxcpu|add:node.cpu}} - {{ node.cpu }}];

                            var backgroundColor = ["rgb(235,150,22)","rgba(234,220,220,0.7)", ];
                            var options = {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    datalabels: {
                                        formatter: (value, context) => {
                                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            let percentage = (value / total * 100).toFixed(1) + "%";
                                            return percentage;
                                        },
                                        color: '#fff',
                                        labels: {
                                            title: {
                                                font: {
                                                    weight: 'bold'
                                                }
                                            }
                                        }
                                    }
                                }
                            };

                            new Chart(ctxMemory, {
                                type: "pie",
                                data: { labels: ["Use", "Free"], datasets: [{ backgroundColor, data: dataMemory }] },
                                options,
                                plugins: [ChartDataLabels]
                            });
                            new Chart(ctxDisk, {
                                type: "pie",
                                data: { labels: ["Use", "Free"], datasets: [{ backgroundColor, data: dataDisk }] },
                                options,
                                plugins: [ChartDataLabels]
                            });
                            new Chart(ctxCpu, {
                                type: "pie",
                                data: { labels: ["Use", "Free"], datasets: [{ backgroundColor, data: dataCpu }] },
                                options,
                                plugins: [ChartDataLabels]
                            });
                        });
                    </script>
                    {% else %}
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item bg-transparent mt-4">
                            <h2 class="accordion-header" id="heading-{{ node.node }}">
                                <button style="background-color: #ef89a3" class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ node.node }}" aria-expanded="true" aria-controls="collapse-{{ node.node }}">
                                    <i class="fa bi-toggle2-off fa-2x me-4"></i>{{ node.node }}
                                </button>
                            </h2>
                            <div id="collapse-{{ node.node }}" class="accordion-collapse collapse show" aria-labelledby="heading-{{ node.node }}" data-bs-parent="#accordionExample">

                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
